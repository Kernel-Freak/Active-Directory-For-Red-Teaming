# Active-Directory-For-Red-Teaming
# Active Directory Home Lab Project - README

This document summarises the content of the YouTube video series "Active Directory Project (Home Lab)" by MyDFIR. The project guides you through building a home lab environment with Active Directory, Splunk, and Kali Linux for both blue team and red team learning [1].

## Project Overview

The goal of this five-part series is to build a fully functional on-premise domain environment from scratch [2]. By completing this project, you will learn how to install and configure Active Directory, Splunk, and Windows machines [2]. This hands-on project will allow you to understand Active Directory administration, how a domain works, and how to use Splunk for ingesting and analysing security telemetry [1]. You will also learn about performing attacks and generating telemetry for detection [1, 3].

## Video Summaries

### Part 1: Intro [1, 3-8]

*   The majority of organisations use Active Directory to manage resources like users, computers, and groups [1].
*   This project series will guide you through setting up your own Active Directory environment for learning administration and domain functionality [1].
*   You will also set up a Splunk instance to ingest events from a Windows server with Active Directory and a target Windows machine [1].
*   The series will culminate in using Kali Linux to perform a Brute Force attack and Atomic Red Team for generating telemetry [1].
*   This is a hands-on project, so allocate sufficient time if you want to participate [1].
*   A key recommendation for any project is to build a diagram, which is also crucial for interview scenarios where you might be asked to draw one and explain how to secure it [4].
*   Part two will cover downloading and installing the necessary assets: Windows Server 2022, Windows 10, Cali Linux, and Splunk using Ubuntu Server, all within VirtualBox [4].
*   VirtualBox allows you to take snapshots of your virtual machines, enabling experimentation without fear of mistakes [3, 4].
*   Red team enthusiasts can launch attacks from Kali Linux towards the Active Directory environment to understand attack mechanisms [4].
*   Blue teamers can learn to detect and create alerts using telemetry generated by the server or target machine while learning Splunk [3].
*   Part three will focus on installing and configuring Sysmon for logging and Splunk as the SIEM for querying telemetry and creating alerts, dashboards, and reports [3]. While the series won't cover the creation of alerts, reports, or dashboards in detail, Splunk's documentation and free training are recommended [3].
*   Part three is critical for ensuring telemetry can be queried correctly [5].
*   Part four will cover configuring Active Directory on the Windows server and promoting it to a domain controller, creating domain users, and joining the target PC to the domain [6].
*   Part five will involve using Kali Linux for a Brute Force attack on a domain user and observing the telemetry in Splunk. Atomic Red Team will also be used to generate further telemetry [6].
*   A separate troubleshooting video will be available [6].
*   Encountering errors is part of the learning process; research them and, if unresolved, ask in the comments [7].
*   Some of the material in this project is taught in more detail in the creator's SOC course, which includes more attack scenarios and building alerts, reports, and dashboards in Splunk [7].
*   Consider adding this project to your portfolio on a free site like GitHub [8].

### Part 2: Part 1 (Diagram) [2, 9-20]

*   This part focuses on creating a logical diagram of the lab and outlining hardware requirements [9].
*   Users with M1, M2, or M3 Macs will likely need to set up the lab in the cloud using providers like Vultr or Azure due to virtualization limitations [9, 21]. Windows users can use VirtualBox [9].
*   The diagram helps understand data flow and how components are interconnected [9].
*   Creating a basic lab diagram might be asked in interviews, so this project will build confidence in doing so [10].
*   draw.io is used to create the diagram as it is free and quick to access [10]. Diagrams don't need to be aesthetically perfect initially; focus on functionality [10].
*   Recommended hardware includes at least 16 GB of RAM and 250 GB of disk space. Lower specifications might lead to performance issues [10].
*   The diagram includes two servers (Splunk and Active Directory), two computers (target and attacker), a switch, a router, and a cloud representing the internet [11, 12, 20]. The attacker machine is coloured red for easy differentiation [12].
*   Icons are connected using arrows in draw.io [12, 13]. Connections can be adjusted to be straight lines for a cleaner look [14].
*   Network information is added to the diagram, including the domain name (`mydfir.local`), network range (192.168.10.0/24), and IP addresses for the Splunk server (192.168.10.10), Active Directory server (192.168.10.7), and attacker machine (192.168.10.250) [15].
*   Labels are added to the icons to identify their roles and IP addresses [15, 16].
*   The Active Directory server and target machine will have Splunk Universal Forwarder and Sysmon installed [16]. The target machine will also have Atomic Red Team [18].
*   Dotted green lines in the diagram indicate the forwarding of logs to the Splunk server [17].
*   The diagram provides a better understanding of the lab's connections [18]. More advanced components like IDS, EDR, or firewalls can be added for a more complex lab [18, 19].
*   The diagram will be referenced throughout the project series [19, 20].

### Part 3: Part 2 (Installation) [21-40]

*   This part focuses on installing the virtual machines on VirtualBox: Windows 10 (target), Cali Linux (attacker), Ubuntu Server 22.04 (Splunk), and Windows Server 2022 (Active Directory) [21, 23].
*   M1, M2, or M3 Mac users should use cloud providers like Vultr or Microsoft Azure [21]. A link for Vultr with free credit is provided [21].
*   A high-level overview of Active Directory is given: a database containing users, computers, groups, etc. [22]. Active Directory Domain Services (AD DS) must be installed on a server, which is then promoted to a domain controller (DC) [22].
*   Promoting a server to a DC enables authentication using Kerberos and authorisation for the domain [22]. AD DS contains objects with attributes [22].
*   The video demonstrates installing VirtualBox from virtualbox.org, including verifying the downloaded file using SHA256 checksums [23, 24]. A Microsoft Visual C++ 2019 package dependency might be required [25].
*   The process of downloading a Windows 10 ISO image using the Media Creation Tool is shown [26, 27].
*   Creating a Windows 10 virtual machine in VirtualBox is demonstrated, including configuring memory (4GB), CPU (1), and disk space (50GB) [27-29]. Manual installation is chosen over unattended installation [28].
*   Downloading and importing a pre-built Kali Linux virtual machine from cali.org into VirtualBox is shown [30-32]. The default credentials for Kali are `kali:kali` [32].
*   The process of downloading a Windows Server 2022 ISO from the Microsoft Evaluation Center is outlined [33].
*   Creating a Windows Server 2022 virtual machine in VirtualBox is demonstrated, with at least 4GB of RAM recommended initially [34, 35]. Selecting "Windows Server 2022 Standard (Desktop Experience)" is crucial for a GUI [35]. Setting a secure administrator password is shown [36].
*   Installing Ubuntu Server 22.04 from ubuntu.com for the Splunk server is demonstrated [37, 38]. At least 8GB of RAM and 100GB of disk space are recommended for the Splunk VM [37]. Setting up a username and password during the Ubuntu installation is shown [38]. OpenSSH installation is optional [38].
*   After installation, updating and upgrading the Ubuntu server repositories is shown using `sudo apt get update` and `sudo apt get upgrade -y` [40].

### Part 4: Part 3 (Sysmon & Splunk) [41-69]

*   This part covers installing and configuring Sysmon and Splunk on the Windows target machine and server to collect and send telemetry to the Splunk server [41].
*   Network settings for all virtual machines are changed to **NAT Network** to ensure they are on the same network and have internet access [41, 42]. A new NAT Network named "ad project" with the IP prefix 192.168.10.0/24 is created [42].
*   The Splunk server's IP address is statically set to **192.168.10.10** as per the diagram by editing the `/etc/netplan/` configuration file [43-46]. The DHCP setting is changed to `false`, and the `addresses`, `nameservers`, and `routes` are configured [44, 45]. The `netplan apply` command applies the changes [46].
*   Installing Splunk Enterprise on the Ubuntu server involves downloading the .deb file from splunk.com (requires account and login) [46, 47].
*   VirtualBox Guest Additions are installed on the Splunk server using `sudo apt get install virtualbox-guest-additions-iso` [47, 48].
*   A shared folder is set up in VirtualBox to transfer the Splunk installer to the Ubuntu server [48, 49]. The user is added to the `vboxsf` group using `sudo adduser <username> vboxsf` [49]. `virtualbox-guest-utils` might need to be installed first [50]. A reboot is required after adding the user to the group [50].
*   A `share` directory is created on the Splunk server, and the shared folder is mounted using `sudo mount -t vboxsf -o uid=1000,gid=1000 active-directory-project /home/<username>/share` (adjust the shared folder name) [50-52].
*   Splunk Enterprise is installed on the Ubuntu server using `sudo dpkg -i /home/<username>/share/<splunk_installer.deb>` [52].
*   The Splunk service is started by switching to the `splunk` user (`sudo su - splunk`), navigating to `/opt/splunk/bin`, and running `./splunk start --accept-license` [52, 53]. An administrative username and password are created during the first start [53].
*   Splunk is configured to start on boot using `sudo /opt/splunk/bin/splunk enable boot-start -user splunk` [53].
*   The host name of the Windows target machine is changed to "Target-PC" [54].
*   The IP address of the Windows target machine is statically set to **192.168.10.100** to avoid conflicts [55, 56]. The DNS server is temporarily set to 8.8.8.8 [55].
*   Accessing the Splunk web interface on `http://192.168.10.10:8000` is verified [56].
*   Splunk Universal Forwarder is installed on the Windows target machine by downloading the MSI installer from splunk.com [56, 57]. During installation, it is configured to send data to the Splunk server at IP **192.168.10.10** on port **9997** [57].
*   Sysmon is downloaded from Sysinternals (Microsoft) [58]. A Sysmon configuration file (`sysmonconfig.xml`) by Olaf Hartong is downloaded from GitHub [58].
*   Sysmon is installed on the target machine using PowerShell with administrative privileges: `Sysmon64.exe -i sysmonconfig.xml -accepteula` [59].
*   The Splunk Universal Forwarder is configured to send Sysmon and other logs to the Splunk server by creating an `inputs.conf` file in `C:\Program Files\SplunkUniversalForwarder\etc\system\local\` [60-62]. **Do not edit the file in the default directory.** The `inputs.conf` file specifies the data sources (Application, Security, System, Sysmon) and the index (`endpoint`) [61, 62].
*   The Splunk Forwarder service is restarted after creating or modifying `inputs.conf`. The "Log On As" setting for the Splunk Forwarder service should be "Local System account" [63, 64].
*   On the Splunk server web interface, an **index named `endpoint`** is created under Settings > Indexes [65].
*   The Splunk server is configured to receive data on port **9997** under Settings > Forwarding and Receiving > Configure receiving > New receiving port [66].
*   Verifying data ingestion from the target machine by searching `index=endpoint` in the Splunk Search & Reporting app is shown [66, 67]. Events from "Target-PC" with source types related to Security, Application, System, and Sysmon should be present [67].
*   The process of installing Sysmon and Splunk Universal Forwarder on the Windows Server (AD DC) is left as a hands-on exercise for the user, following the same steps as the target machine [54, 67]. The computer name of the AD DC should be changed to "ADDC-01" [67, 68]. If configured correctly, two hosts ("Target-PC" and "ADDC-01") should appear in Splunk [68].

### Part 5: Part 4 (Active Directory) [70-82]

*   This part covers installing and configuring Active Directory Domain Services (AD DS) on the Windows Server 2022 virtual machine [70].
*   A static IP address of **192.168.10.7** is configured on the AD DC server [70, 71]. The DNS server is set to **8.8.8.8** initially [71].
*   Active Directory Domain Services is installed via Server Manager: Manage > Add Roles and Features [72]. Select "Active Directory Domain Services" and add the required features [72].
*   After installation, the server is promoted to a domain controller by clicking the notification flag in Server Manager and selecting "Promote this server to a domain controller" [73].
*   A new forest is added, and the root domain name is set to **`mydfir.local`** [73]. A Directory Services Restore Mode (DSRM) password is set [73]. Default paths for the AD database (ntds.dit) are kept [73, 74].
*   After the promotion, the server restarts and logging in shows the domain prefix (e.g., `mydfir\Administrator`) [74, 75].
*   Users are created using Active Directory Users and Computers (accessible via Server Manager > Tools) [75].
*   Organisational Units (OUs) are created (e.g., "IT" and "HR") to organise users [76, 77].
*   New users ("Jenny Smith" with username "JSmith" in the "IT" OU and "Terry Smith" with username "TSmith" in the "HR" OU) are created with passwords set (with the "User must change password at next logon" option unchecked for the lab environment) [77, 78].
*   The Windows 10 target machine is joined to the newly created domain `mydfir.local` [78, 79]. This requires changing the target machine's DNS server to point to the domain controller's IP address (**192.168.10.7**) [79].
*   Joining the domain is done via System Properties > Computer Name > Change > Domain [78]. Administrator credentials for the domain are required to join [80].
*   After joining, the target machine needs to be restarted [80].
*   Logging into the joined machine with a domain user account (e.g., `mydfir\JSmith`) is demonstrated [80, 81].
*   Taking snapshots of all virtual machines is recommended as a backup [81].

### Part 6: Part 5 (Brute Force & Atomic Red Team) [83-103]

*   This final part involves using Kali Linux to perform a Brute Force attack and setting up Atomic Red Team on the Windows target machine [83].
*   The RAM for the DC and target machines can be reduced to 2GB if the host machine has limited resources (less than 16GB) [83].
*   A static IP address of **192.168.10.250** is configured on the Kali Linux machine [84, 85].
*   The Kali Linux repositories are updated and upgraded using `sudo apt get update` and `sudo apt get upgrade -y` [86].
*   A new directory `ad-project` is created on the Kali Desktop to store attack-related files [86].
*   The `crowbar` tool is installed using `sudo apt get install -y crowbar` [86, 87]. **Use this tool only on systems you have explicit permission to test.**
*   The `rockyou.txt.gz` password list (located in `/usr/share/wordlists/`) is unzipped (`sudo gunzip rockyou.txt.gz`) and copied to the `ad-project` directory [87, 88].
*   A smaller `password.txt` file containing the first 20 lines of `rockyou.txt` and a specific "super secure password" is created for the Brute Force attack [88, 89].
*   Remote Desktop (RDP) is enabled on the Windows target machine, and the domain users Jenny Smith and Terry Smith are added as allowed users [89, 90].
*   A Brute Force attack is launched from Kali Linux using `crowbar -b rdp -u TSmith -C password.txt -s 192.168.10.100/32` (targeting Terry Smith on the target machine) [91, 92].
*   The successful Brute Force attempt reveals the password in the crowbar output [92].
*   In Splunk, searching `index=endpoint TSmith` within the last 15 minutes reveals event ID **4625** (Account Failed to Log On) indicating the failed attempts [93]. Event ID **4624** (An account was successfully logged on) shows the successful login, including the workstation name (Cali) and IP address [94].
*   Atomic Red Team is installed on the Windows target machine using PowerShell with administrative privileges [95]. The execution policy is bypassed (`Set-ExecutionPolicy Bypass -Scope CurrentUser -Force`), and an exclusion for the entire C drive is added in Windows Security to prevent Defender from interfering with Atomic Red Team files [95, 96].
*   Atomic Red Team is installed using a specific PowerShell command (provided in the video description) [96].
*   Atomic tests, organised by MITRE ATT&CK technique IDs, are located in `C:\Atomic Red Team\atomics\` [96, 97].
*   An example test for creating a local account (T1136.001) is executed using `Invoke-AtomicTest T1136.001` in PowerShell [97, 98]. While initial searches for the new local user in Splunk might not yield results immediately, the event should eventually be logged [98, 100].
*   Another test for command and scripting interpreter (PowerShell - T1059.001) is executed using `Invoke-AtomicTest T1059.001` [99]. The event, including "exact bypass no profile," is visible in Splunk, demonstrating a potential detection opportunity [99, 100].
*   It is crucial to ensure the password being Brute Forced is present in the `password.txt` file [100, 101].
*   Taking snapshots in VirtualBox as backups is reiterated [101, 102].
*   The importance of understanding the MITRE ATT&CK framework for blue teamers is highlighted [102].

### Part 7: Troubleshooting [104-109]

*   This video addresses common errors encountered during the project [104].
*   **Windows Server Installation:** Ensure "Skip unattended installation" is checked to avoid licensing term errors [104].
*   **Windows Server to Splunk Communication:** Verify network connectivity by pinging the Splunk server. Ensure the correct `inputs.conf` file (available on GitHub) is used and the Splunk Forwarder service is restarted with the "Local System account" [104, 105].
*   **Windows Target Machine Joining Domain:** Use the full domain name (including the top-level domain), double-check network connectivity, and ensure the DNS is pointing to the domain controller [105, 106]. If DHCP fails, try setting a static IP [106]. Verify the `inputs.conf` and Splunk Forwarder service settings for log forwarding [106].
*   **Splunk Server Receiving Data:** Ensure the `endpoint` index exists (Settings > Indexes) and that Splunk is listening on port **9997** (Settings > Forwarding and Receiving > Configure receiving) [107]. Restarting the server might help [107]. Atomic Red Team events might take a few minutes to appear [108].
*   **Kali Linux:** Update and upgrade repositories before installing crowbar. Enable RDP on target machines for Brute Force attack examples. Ensure the password being Brute Forced is in `password.txt` [108, 109].

## Further Learning

Consider exploring the creator's SOC course for more in-depth learning about security operations, including querying Splunk and finding malicious activity using the MITRE ATT&CK framework [7, 67, 102, 103].

Remember to stay curious and do things differently! [8, 20, 40, 69, 82, 103, 109]

